---
title: "Forecasting of financial instruments using VECM and ARIMA models"
author: "Nihad Alili"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setting Up Working Directory and Loading Functions

```{r}
getwd()
setwd("C:/Users/User/OneDrive/Desktop/Project") # Replace with the actual path
source("functions/testdf.R")
```

## Installing Necessary Packages

```{r}
install.packages("xts")
install.packages("lmtest")
install.packages("forecast")
install.packages("quantmod")
install.packages("urca")
install.packages("vars")
install.packages("tseries")
```

## Loading Libraries

```{r}
library(xts)
library(lmtest)
library(tidyverse)
library(readr)
library(ggplot2)
library(vars)
library(quantmod)
library(urca)
library(forecast)
library(tseries)
```

## Loading and Organizing Financial Data

```{r}
financial_data <- read.csv("C:/Users/User/OneDrive/Desktop/Project/TSA_2024_project_data_1 (2).csv", header = TRUE)

financial_data %>% glimpse()
head(financial_data)
tail(financial_data)

financial_data$date <- as.Date(financial_data$date, format = "%Y-%m-%d")
financial_data <- xts(financial_data[, -1], order.by = financial_data$date)
head(financial_data)
```

## Data Visualization

```{r}
# Plotting all financial instruments
financial_data[, 1:10] %>%
  as_tibble() %>%
  mutate(date = index(financial_data)) %>%
  pivot_longer(!date) %>%
  ggplot(aes(date, value, col = name)) +
  geom_line() +
  theme_bw() +
  labs(title = "Plotting all financial instruments in one graph")
```

```{r}

# Reshape and plot individual instruments
financial_data_long <- financial_data %>%
  as_tibble() %>%
  mutate(date = index(financial_data)) %>%
  pivot_longer(-date, names_to = "instrument", values_to = "value")

ggplot(financial_data_long, aes(x = date, y = value, color = instrument)) +
  geom_line() +
  theme_bw() +
  labs(title = "Plot of Financial Instruments", x = "Date", y = "Value") +
  facet_wrap(~instrument, scales = "free_y", ncol = 3) +
  theme(legend.position = "none")
```
Visually, we can commit that none of them are stationary and there are 4 cointegrated pair. However, we will need to check them statisticially.

## ADF Tests on Variables

```{r}
adf_result <- adf.test(financial_data$y1, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y2, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y3, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y4, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y4, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y5, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y6, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y7, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y8, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y9, alternative = "stationary", k = 3)
print(adf_result)

adf_result <- adf.test(financial_data$y10, alternative = "stationary", k = 3)
print(adf_result)
```
As we can see p value of 

## Calculating Differences for Stationarity

```{r}
financial_data$dy1 <- diff.xts(financial_data$y1)
financial_data$dy2 <- diff.xts(financial_data$y2)
financial_data$dy3 <- diff.xts(financial_data$y3)
financial_data$dy4 <- diff.xts(financial_data$y4)
financial_data$dy5 <- diff.xts(financial_data$y5)
financial_data$dy6 <- diff.xts(financial_data$y6)
financial_data$dy7 <- diff.xts(financial_data$y7)
financial_data$dy8 <- diff.xts(financial_data$y8)
financial_data$dy9 <- diff.xts(financial_data$y9)
financial_data$dy10 <- diff.xts(financial_data$y10)
```

# ADF test for differenced y

```{r}
testdf(variable = financial_data$dy1, #ADF test variable 1
       max.augmentations = 3)
testdf(variable = financial_data$dy2, #ADF test variable 2
       max.augmentations = 3)
       testdf(variable = financial_data$dy3, #ADF test variable 3
              max.augmentations = 3)
       testdf(variable = financial_data$dy4, #ADF test variable 4
              max.augmentations = 3)
       
       testdf(variable = financial_data$dy5, #ADF test variable 5
              max.augmentations = 3)
       testdf(variable = financial_data$dy6, #ADF test variable 6
              max.augmentations = 3)
       testdf(variable = financial_data$dy7, #ADF test variable 7
              max.augmentations = 3)
       testdf(variable = financial_data$dy8, #ADF test variable 8
              max.augmentations = 3)
       testdf(variable = financial_data$dy9, #ADF test variable 9
              max.augmentations = 3)
       
       
       testdf(variable = financial_data$dy10, #ADF test variable 10
 
                         max.augmentations = 3)
```

#Estimate cointegrate vector

```{r}
model.coint <- lm(y3 ~ y10, data = financial_data) #There are 4 cointegrated vector but I choosed y3 and y10
summary(model.coint)
```

#Checking stationary among residuals

```{r}
testdf(variable = residuals(model.coint), max.augmentations = 3)
```

# Plot the cointegrated pairs

```{r}
plot(financial_data[, c(3,10)],
     col = c("black", "blue"),
     major.ticks = "years", 
     grid.ticks.on = "years",
     grid.ticks.lty = 3,
     main = "",
     legend.loc = "topleft")


financialdata_y3_y10 <- financial_data[ , c("y3", "y10")]
tail(financialdata_y3_y10)
```

#Johansen Cointegration test

```{r}
johansen_result_trace <- ca.jo(financialdata_y3_y10, type = "trace", K = 6, ecdet = "const")                 
summary(johansen_result_trace) #trace test
```

#Alternative variant of the test\

```{r}
johansen_result_eigen <- ca.jo(financialdata_y3_y10, type = "eigen", K = 6, ecdet = "const") 
summary(johansen_result_eigen) #eigen test
str(johansen_result_eigen)
```

#Estimatin VECM

```{r}
TMS.vec4 <- cajorls(johansen_result_eigen, r = 1)

summary(TMS.vec4)
str(TMS.vec4)
summary(TMS.vec4$rlm)
TMS.vec4$beta
```

#Repramatrize from VECM to VAR

```{r}
TMS.vec4.asVAR <- vec2var(johansen_result_eigen, r = 1)
TMS.vec4.asVAR
```

#Plot

```{r}
irf_result <- irf(TMS.vec4.asVAR)
plot(irf_result)
```

#FEVD diagnostics

```{r}
plot(fevd(TMS.vec4.asVAR, n.ahead = 20))
```

# Perform the Portmanteau test

```{r}
head(residuals(TMS.vec4.asVAR))
portmanteau_test <- serial.test(TMS.vec4.asVAR)
print(portmanteau_test)
plot(portmanteau_test)
```

# Perform the Jarque-Bera test

```{r}
jb_test <- normality.test(TMS.vec4.asVAR)
print(jb_test)
```

#Forecasting out of sample

```{r}
TMS.testdata <- financial_data["/3/7/2022", ]
TMS.testdata <- subset(TMS.testdata, select = c(y3, y10))
tail(TMS.testdata)
johan.test.eigen2.testdata <- ca.jo(TMS.testdata,
                                 ecdet = "const",
                                 type = "trace", 
                                 K = 4)
summary(johan.test.eigen2.testdata)

TMS.vec4.fore <- 
  predict(
    vec2var(
      johan.test.eigen2.testdata, 
      r = 1),     # no of cointegrating vectors 
    n.ahead = 20, # forecast horizon
    ci = 0.95)    # confidence level for intervals

TMS.vec4.fore$fcst$y3
TMS.vec4.fore$fcst$y10

tail(index(financial_data), 20)
y3_forecast <- xts(TMS.vec4.fore$fcst$y3[,-4], 
                   # we exclude the last column with CI
                   tail(index(financial_data), 20))

names(y3_forecast) <- c("y3_fore", "y3_lower", "y3_upper")

y10_forecast <- xts(TMS.vec4.fore$fcst$y10[,-4],
                   # we exclude the last column with CI
                   tail(index(financial_data), 20))



names(y10_forecast) <- c("y10_fore", "y10_lower", "y10_upper")


financial_data_fore <- merge(financial_data, 
                 y3_forecast,
                 y10_forecast)
```

#Visualisation of forecasts

```{r}
plot(financial_data_fore[index(financial_data_fore) > as.Date("2022-03-07"), c("y3", "y3_fore",
                                             "y3_lower", "y3_upper")], 
     
     main = "20 days forecast of instrument y3",
     col = c("black", "blue", "red", "red"))


plot(financial_data_fore[index(financial_data_fore) > as.Date("2022-03-07"), c("y10", "y10_fore",
                                                                     "y10_lower", "y10_upper")], 
     
     main = "20 days forecast of instrument y10",
     col = c("black", "blue", "red", "red"))
```
